<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Libby McKenna">
<meta name="dcterms.date" content="2024-11-19">

<title>This quiz will tell you your chemical dosing personality type – sidestreams</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../tw_logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-listing/list.min.js"></script>
<script src="../../site_libs/quarto-listing/quarto-listing.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/alpine-3.12/buttons.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>

  window.document.addEventListener("DOMContentLoaded", function (_event) {
    const listingTargetEl = window.document.querySelector('#listing-listing .list');
    if (!listingTargetEl) {
      // No listing discovered, do not attach.
      return; 
    }

    const options = {
      valueNames: [{ data: ['index'] },{ data: ['categories'] },{ data: ['listing-date-sort'] },{ data: ['listing-file-modified-sort'] }],
      
      searchColumns: [],
    };

    window['quarto-listings'] = window['quarto-listings'] || {};
    window['quarto-listings']['listing-listing'] = new List('listing-listing', options);

    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  });

  window.addEventListener('hashchange',() => {
    if (window['quarto-listing-loaded']) {
      window['quarto-listing-loaded']();
    }
  })
  </script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">sidestreams</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sources.html"> 
<span class="menu-text">Sources</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">This quiz will tell you your chemical dosing personality type</h1>
            <p class="subtitle lead">How to use tidywater’s helper functions to model large data sets</p>
                                <div class="quarto-categories">
                <div class="quarto-category">helper_functions</div>
                <div class="quarto-category">acid_base_equilibrium</div>
                <div class="quarto-category">chemdose_ph</div>
                <div class="quarto-category">solvedose_ph</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Libby McKenna </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 19, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#whats-your-chemical-dosing-personality-type" id="toc-whats-your-chemical-dosing-personality-type" class="nav-link active" data-scroll-target="#whats-your-chemical-dosing-personality-type">What’s your chemical dosing personality type?</a>
  <ul class="collapse">
  <li><a href="#quiz" id="toc-quiz" class="nav-link" data-scroll-target="#quiz">Quiz</a></li>
  </ul></li>
  <li><a href="#chemical-dosing-setup" id="toc-chemical-dosing-setup" class="nav-link" data-scroll-target="#chemical-dosing-setup">Chemical Dosing Setup</a></li>
  <li><a href="#multi-scenario-setup" id="toc-multi-scenario-setup" class="nav-link" data-scroll-target="#multi-scenario-setup">Multi-Scenario Setup</a></li>
  <li><a href="#chemdose_ph_chain" id="toc-chemdose_ph_chain" class="nav-link" data-scroll-target="#chemdose_ph_chain"><code>chemdose_ph_chain</code></a></li>
  <li><a href="#solvedose_ph_once" id="toc-solvedose_ph_once" class="nav-link" data-scroll-target="#solvedose_ph_once"><code>solvedose_ph_once</code></a></li>
  <li><a href="#multiple-chemicals" id="toc-multiple-chemicals" class="nav-link" data-scroll-target="#multiple-chemicals">Multiple chemicals</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="whats-your-chemical-dosing-personality-type" class="level2">
<h2 class="anchored" data-anchor-id="whats-your-chemical-dosing-personality-type">What’s your chemical dosing personality type?</h2>
<p>What does that mean, you ask? It has about the same meaning as a click bait site telling you who you are based on your food preferences. I have a pizza personality, and therefore, I must be saucy yet versatile.</p>
<p>Once you find your chemical dosing personality type, read on for an example on how to apply your favorite function.</p>
<section id="quiz" class="level3">
<h3 class="anchored" data-anchor-id="quiz">Quiz</h3>
<div class="question">
<p>On a scale of 1-14, how extroverted are you? 1 = I’m a solo proton type of gal, 14 = OH OH OH I LOVE PEOPLE <input type="number" id="extroversion" min="1" max="14"> <button onclick="checkAnswer()">Submit</button></p>
</div>
<div id="feedback">

</div>
<script>
function checkAnswer() {
  var answer = document.getElementById("extroversion").value;
  var feedback = document.getElementById("feedback");
  if (answer >= 1 && answer <= 5) {
    feedback.innerHTML = "You're a very positive person, but sooo acidic. Let's add some alkalinity! Check out solvedose_alk to figure out how much chemical to add to reach a new alkalinity. New carbonate balance, new you.";
  } else if (answer >= 6 && answer <= 8) {
    feedback.innerHTML = "So neutral, time for a makeover up with some chemical addition. Use chemdose_ph to see your new pH after adding a chemical. Choose your chemical wisely!";
  } else if (answer >= 9 && answer <= 14) {
    feedback.innerHTML = "Ya basic! Let's drop that pH. Use solvedose_ph to find how much chemical is required to move you from a Starbucks regular to a local cafe champion.";
  } else {
    feedback.innerHTML = "Please enter a valid number between 1 and 14.";
  }
}
</script>
<p>:::::</p>
<p>This post assumes a basic understanding of <code>define_water</code>, the S4 <code>water</code> class, and helper functions. See <code>vignette("intro", package = "tidywater")</code> and <code>vignette("help_functions_blend", package = "tidywater")</code> for more information.</p>
</section>
</section>
<section id="chemical-dosing-setup" class="level2">
<h2 class="anchored" data-anchor-id="chemical-dosing-setup">Chemical Dosing Setup</h2>
<p>To showcase tidywater’s acid-base equilibrium functions, let’s use a common water treatment problem. In this analysis, a hypothetical drinking water utility wants to know how much their pH will be impacted by varying doses of alum. They also want to ensure that their finished water has a pH of 8.</p>
<p>We can create a quick model by manually inputting the utility’s typical water quality. Then we’ll dose the water with their typical alum dose of 30 mg/L, and then a proposed 20 mg/L dose. Finally, we’ll see how much caustic is required to raise the pH back to 8.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use define_water to prepare for tidywater analysis</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>no_alum_water <span class="ot">&lt;-</span> <span class="fu">define_water</span>(<span class="at">ph =</span> <span class="fl">8.3</span>, <span class="at">temp =</span> <span class="dv">18</span>, <span class="at">alk =</span> <span class="dv">150</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dose 30 mg/L of alum</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>alum_30 <span class="ot">&lt;-</span> no_alum_water <span class="sc">%&gt;%</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph</span>(<span class="at">alum =</span> <span class="dv">30</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph</span>(<span class="at">target_ph =</span> <span class="dv">8</span>, <span class="at">chemical =</span> <span class="st">"naoh"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>alum_30 <span class="co"># Caustic dose required to raise pH to 8 when 30 mg/L of alum is added</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dose 20 mg/L of alum</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>alum_20 <span class="ot">&lt;-</span> no_alum_water <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph</span>(<span class="at">alum =</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph</span>(<span class="at">target_ph =</span> <span class="dv">8</span>, <span class="at">chemical =</span> <span class="st">"naoh"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>alum_20 <span class="co"># Caustic dose required to raise pH to 8 when 20 mg/L of alum is added</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.2</code></pre>
</div>
</div>
<p>As expected, a lower alum dose requires a lower caustic dose to reach the target pH.</p>
<p>But what if the utility wants to test a variety of alum doses on a range of their water quality? We’ll use the power of tidywater’s <code>_chain</code> functions to extend this analysis to a full dataframe. For more information on tidywater’s <code>_chain</code> functions, please see the <code>vignette("help_functions_blend_waters", package = "tidywater")</code>.</p>
</section>
<section id="multi-scenario-setup" class="level2">
<h2 class="anchored" data-anchor-id="multi-scenario-setup">Multi-Scenario Setup</h2>
<p>We’ll use tidywater’s built-in water quality data, <code>water_df</code>, then apply <code>define_water_chain</code> and <code>balance_ions_chain</code> to convert the data to a <code>water</code> object. We’ll also set a range of alum doses to see how they affect each water quality scenario.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a range of alum doses</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>alum_doses <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">alum =</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">10</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use tidywater's built-in synthetic data, water_df, for this example</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>raw_water <span class="ot">&lt;-</span> water_df <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_water_chain</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">balance_ions_chain</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join alum doses to create several dosing scenarios.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(alum_doses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chemdose_ph_chain" class="level2">
<h2 class="anchored" data-anchor-id="chemdose_ph_chain"><code>chemdose_ph_chain</code></h2>
<p>Now that we’re set up, let’s dose some alum! To do this, we’ll use <code>chemdose_ph_chain</code>, a function whose tidywater base is <code>chemdose_ph</code>. The <code>chemdose_ph_chain</code> function requires dosed chemicals to match the argument’s notation. In this case, our chemical is already properly named. Other chemicals, such as caustic, ferric sulfate, soda ash and more would need to be named <code>naoh</code>, <code>fe2so43</code>, and <code>na2co3</code>, respectively. Most tidywater chemicals are named with their chemical formula, all lowercase and no special characters.</p>
<p>There are two ways to dose chemicals.</p>
<ol type="1">
<li><p>You can pass an appropriately named column into the function, or</p></li>
<li><p>You can specify the chemical in the function.</p></li>
</ol>
<p>Let’s look at both options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Use an existing column in your data frame to dose a chemical.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    Here, we use the alum column as the dosed chemical.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>dose_column_water <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>) <span class="sc">%&gt;%</span> <span class="co"># The function recognizes the 'alum' column as the chemical dose</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck_water</span>(<span class="at">input_water =</span> <span class="st">"dosed_chem_water"</span>, <span class="at">parameter =</span> <span class="st">"ph"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water, balanced_water))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dose_column_water)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                        dosed_chem_water alum
1 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   10
2 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   20
3 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
4 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   40
5 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   50
6 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   60
  dosed_chem_water_ph
1                7.17
2                6.86
3                6.64
4                6.45
5                6.28
6                6.10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Dose a chemical in the function. Rename the alum column so it doesn't get used in the function</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dose_argument_water <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">coagulant =</span> alum) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>, <span class="at">alum =</span> <span class="dv">30</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck_water</span>(<span class="at">input_water =</span> <span class="st">"dosed_chem_water"</span>, <span class="at">parameter =</span> <span class="st">"ph"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water, balanced_water))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dose_argument_water)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  coagulant                                       dosed_chem_water alum
1        10 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
2        20 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
3        30 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
4        40 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
5        50 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
6        60 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;   30
  dosed_chem_water_ph
1                6.64
2                6.64
3                6.64
4                6.64
5                6.64
6                6.64</code></pre>
</div>
</div>
<p>For Option 1, notice that the <code>ph</code> column has a different result for each row. This shows how powerful the tidywater functions are for simulating multiple doses for multiple scenarios. Option 2 creates a column, <code>alum</code> to show what was dosed. This may be useful for plotting or remembering how much alum was dosed.</p>
</section>
<section id="solvedose_ph_once" class="level2">
<h2 class="anchored" data-anchor-id="solvedose_ph_once"><code>solvedose_ph_once</code></h2>
<p>Remember, our original task is to see how alum addition affects the pH, but the finished water pH needs to be 8. First, we’ll use caustic to raise the pH to 8. <code>solvedose_ph_once</code> uses <code>solvedose_ph</code> to calculate the required chemical dose (as chemical, not product) based on a target pH.</p>
<p>Note: How can you remember the difference between <code>solvedose_ph</code> vs <code>chemdose_ph</code>? Any function beginning with “solve” is named for what it is solving for based on one input: SolveWhatItReturns_Input. So, <code>solvedose_ph</code> is solving for a dose based on a target pH. Other treatment functions are set up as WhatHappensToTheWater_WhatYouSolveFor. So with <code>chemdose_ph</code>, chemicals are being dosed, and we’re solving for the resulting pH (and other components of acid/base chemistry). <code>chemdose_toc</code> models the resulting TOC after chemicals are added, and <code>dissolve_pb</code> calculates lead solubility in the distribution system.</p>
<p>Let’s get back to our analysis. Similar to <code>chemdose_ph_chain</code>, <code>solvedose_ph_once</code> can handle chemical selection and target pH inputs as a column or function arguments.<code>solvedose_ph_once</code> outputs a pH, not a <code>water</code> object. Thus, <code>solvedose_ph_chain</code> doesn’t exist because the <code>water</code> isn’t changing, so chaining this function to a downstream tidywater function can be done using normal tidywater operations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Use existing columns in your dataframe to set a target pH and the chemicals to dose</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>raise_ph <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">chemical =</span> <span class="fu">c</span>(<span class="st">"naoh"</span>, <span class="st">"mgoh2"</span>),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_ph =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">8</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>solve_column <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cross_join</span>(raise_ph) <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph_once</span>(<span class="at">input_water =</span> <span class="st">"dosed_chem_water"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water<span class="sc">:</span>dosed_chem_water))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(solve_column)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  alum chemical target_ph dose_required
1   10     naoh         8           4.3
2   10    mgoh2         8           3.2
3   20     naoh         8           8.3
4   20    mgoh2         8           6.1
5   30     naoh         8          12.4
6   30    mgoh2         8           9.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Set the target pH and chemical needed to raise the pH inside the function</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>solve_argument <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph_once</span>(<span class="at">input_water =</span> <span class="st">"dosed_chem_water"</span>, <span class="at">chemical =</span> <span class="st">"naoh"</span>, <span class="at">target_ph =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water<span class="sc">:</span>dosed_chem_water))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(solve_argument)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  alum target_ph chemical dose_required
1   10         8     naoh           4.3
2   20         8     naoh           8.3
3   30         8     naoh          12.4
4   40         8     naoh          16.5
5   50         8     naoh          20.4
6   60         8     naoh          24.6</code></pre>
</div>
</div>
<p>Now that we have the dose required to raise the pH to 8, let’s dose caustic into the water!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dosed_caustic_water <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>, <span class="at">output_water =</span> <span class="st">"alum_dosed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph_once</span>(<span class="at">input_water =</span> <span class="st">"alum_dosed"</span>, <span class="at">chemical =</span> <span class="st">"naoh"</span>, <span class="at">target_ph =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">naoh =</span> dose_required,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">coagulant =</span> alum</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="co"># rename alum column so it doesn't get dosed twice</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"alum_dosed"</span>, <span class="at">output_water =</span> <span class="st">"caustic_dosed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck_water</span>(<span class="at">input_water =</span> <span class="st">"caustic_dosed"</span>, <span class="st">"ph"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water<span class="sc">:</span>chemical))</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dosed_caustic_water)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                           caustic_dosed naoh caustic_dosed_ph
1 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;  4.3             7.99
2 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt;  8.3             7.98
3 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 12.4             8.02
4 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 16.5             8.01
5 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 20.4             7.99
6 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 24.6             8.01</code></pre>
</div>
</div>
<p>You can see the resulting pH from dosing caustic has raised the pH to 8 +/- 0.02 SU.</p>
</section>
<section id="multiple-chemicals" class="level2">
<h2 class="anchored" data-anchor-id="multiple-chemicals">Multiple chemicals</h2>
<p><code>chemdose_ph</code> is powerful because it can handle multiple chemical inputs. To demonstrate this, we will assume the utility regularly operates under enhanced coagulation. Assuming their alum dose is always 30 mg/L and their acid (HCl) dose is always 10 mg/L.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>enhanced_coag_water <span class="ot">&lt;-</span> raw_water <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">alum =</span> <span class="dv">30</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"balanced_water"</span>, <span class="at">output_water =</span> <span class="st">"alum_dosed"</span>, <span class="at">hcl =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck_water</span>(<span class="st">"alum_dosed"</span>, <span class="st">"ph"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">solvedose_ph_once</span>(<span class="at">input_water =</span> <span class="st">"alum_dosed"</span>, <span class="at">target_ph =</span> <span class="dv">8</span>, <span class="at">chemical =</span> <span class="st">"naoh"</span>, <span class="at">output_column =</span> <span class="st">"naoh"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(alum, hcl)) <span class="sc">%&gt;%</span> <span class="co"># remove chemical columns so they don't get dosed again in the next line.</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">chemdose_ph_chain</span>(<span class="at">input_water =</span> <span class="st">"alum_dosed"</span>, <span class="at">output_water =</span> <span class="st">"ph_adjusted"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(defined_water<span class="sc">:</span>alum_dosed, target_ph, chemical))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(enhanced_coag_water)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  alum_dosed_ph                                            ph_adjusted naoh
1          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5
2          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5
3          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5
4          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5
5          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5
6          6.15 &lt;S4 class 'water' [package "tidywater"] with 63 slots&gt; 23.5</code></pre>
</div>
</div>



</section>

<div class="quarto-listing quarto-listing-container-default" id="listing-listing">
<div class="list quarto-listing-default">

</div>
<div class="listing-no-matching d-none">
No matching items
</div>
</div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/libbymckenna\.github\.io\/sidestreams\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="../../site_libs/quarto-contrib/alpine-3.12/alpine@3.12.min.js"></script>
</body></html>